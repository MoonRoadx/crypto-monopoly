<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crypto Monopoly - En ligne</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        h1 {
            text-align: center;
            color: #667eea;
            margin-bottom: 10px;
            font-size: 2.5em;
        }

        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 40px;
            font-size: 1.1em;
        }

        .options-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 40px;
        }

        .option-card {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            padding: 40px 30px;
            border-radius: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            border: 3px solid transparent;
        }

        .option-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            border-color: #667eea;
        }

        .option-icon {
            font-size: 4em;
            margin-bottom: 20px;
        }

        .option-title {
            font-size: 1.5em;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 15px;
        }

        .option-description {
            color: #666;
            line-height: 1.6;
        }

        .form-section {
            display: none;
        }

        .form-section.active {
            display: block;
        }

        .input-group {
            margin-bottom: 25px;
        }

        .input-group label {
            display: block;
            margin-bottom: 10px;
            font-weight: bold;
            color: #333;
            font-size: 1.1em;
        }

        .input-group input {
            width: 100%;
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 10px;
            font-size: 1.1em;
            transition: all 0.3s;
        }

        .input-group input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1);
        }

        .btn {
            width: 100%;
            padding: 18px;
            border: none;
            border-radius: 12px;
            font-size: 1.2em;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: bold;
            margin-bottom: 15px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .room-code-box {
            background: linear-gradient(135deg, #fff3cd, #ffe69c);
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            margin: 30px 0;
            border: 3px solid #ffc107;
        }

        .room-code-label {
            font-size: 1.2em;
            color: #856404;
            margin-bottom: 15px;
            font-weight: bold;
        }

        .room-code {
            font-size: 3em;
            font-weight: bold;
            color: #667eea;
            letter-spacing: 0.15em;
            font-family: 'Courier New', monospace;
            margin: 15px 0;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
        }

        .copy-button {
            background: #28a745;
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 8px;
            font-size: 1em;
            cursor: pointer;
            font-weight: bold;
            margin-top: 15px;
            transition: all 0.3s;
        }

        .copy-button:hover {
            background: #218838;
            transform: scale(1.05);
        }

        .share-section {
            background: #e3f2fd;
            padding: 25px;
            border-radius: 12px;
            margin: 25px 0;
        }

        .share-title {
            font-size: 1.2em;
            color: #0c5460;
            margin-bottom: 15px;
            font-weight: bold;
        }

        .share-link-box {
            background: white;
            padding: 15px;
            border-radius: 8px;
            display: flex;
            gap: 10px;
            align-items: center;
            margin-top: 15px;
        }

        .share-link-box input {
            flex: 1;
            border: none;
            background: transparent;
            font-family: monospace;
            font-size: 0.95em;
            color: #333;
        }

        .info-box {
            background: #d1ecf1;
            border: 2px solid #bee5eb;
            border-radius: 12px;
            padding: 25px;
            margin: 25px 0;
        }

        .info-box h3 {
            color: #0c5460;
            margin-bottom: 15px;
            font-size: 1.3em;
        }

        .info-box ul {
            margin-left: 25px;
            line-height: 1.8;
        }

        .info-box li {
            margin: 10px 0;
            color: #0c5460;
        }

        .info-box strong {
            color: #084d58;
        }

        .waiting-players {
            margin-top: 30px;
        }

        .player-item {
            background: white;
            padding: 20px;
            margin-bottom: 12px;
            border-radius: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-left: 5px solid #667eea;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .player-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .player-avatar {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea, #764ba2);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.5em;
            font-weight: bold;
        }

        .player-name {
            font-size: 1.2em;
            font-weight: bold;
            color: #333;
        }

        .status-badge {
            padding: 8px 20px;
            border-radius: 25px;
            font-weight: bold;
            font-size: 0.95em;
        }

        .status-ready {
            background: #28a745;
            color: white;
        }

        .status-waiting {
            background: #ffc107;
            color: #000;
        }

        .player-count {
            background: #667eea;
            color: white;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            margin-bottom: 20px;
            font-size: 1.1em;
            font-weight: bold;
        }

        @media (max-width: 768px) {
            .options-grid {
                grid-template-columns: 1fr;
            }
            
            .container {
                padding: 25px;
            }

            h1 {
                font-size: 2em;
            }

            .room-code {
                font-size: 2em;
            }
        }

        .success-message {
            background: #d4edda;
            border: 2px solid #c3e6cb;
            color: #155724;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            text-align: center;
            font-size: 1.1em;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üöÄ CRYPTO MONOPOLY üöÄ</h1>
        <p class="subtitle">Multijoueur en ligne - Jouez avec vos amis!</p>

        <!-- Options Screen -->
        <div class="form-section active" id="optionsScreen">
            <div class="options-grid">
                <div class="option-card" onclick="showCreateRoom()">
                    <div class="option-icon">üéÆ</div>
                    <div class="option-title">Cr√©er une partie</div>
                    <div class="option-description">
                        Cr√©ez une nouvelle partie et invitez vos amis √† vous rejoindre
                    </div>
                </div>
                
                <div class="option-card" onclick="showJoinRoom()">
                    <div class="option-icon">üîó</div>
                    <div class="option-title">Rejoindre une partie</div>
                    <div class="option-description">
                        Rejoignez une partie existante avec un code
                    </div>
                </div>
            </div>

            <div class="info-box">
                <h3>üí° Comment jouer en ligne</h3>
                <ul>
                    <li><strong>Cr√©er une partie :</strong> G√©n√©rez un code unique que vos amis pourront utiliser</li>
                    <li><strong>Partager le code :</strong> Envoyez le code de 8 caract√®res √† vos amis par message, email, etc.</li>
                    <li><strong>Jouer ensemble :</strong> Une fois que tout le monde a rejoint, la partie peut commencer!</li>
                    <li><strong>Synchronisation :</strong> Les donn√©es sont synchronis√©es en temps r√©el via le cloud</li>
                </ul>
                <p style="margin-top: 15px; font-style: italic; color: #0c5460;">
                    <strong>Note technique :</strong> Cette version utilise le syst√®me de stockage persistant de Claude pour synchroniser les parties entre joueurs en temps r√©el.
                </p>
            </div>
        </div>

        <!-- Create Room Form -->
        <div class="form-section" id="createRoomScreen">
            <h2 style="color: #667eea; margin-bottom: 30px; text-align: center;">Cr√©er une nouvelle partie</h2>
            
            <div class="input-group">
                <label>Votre nom de joueur</label>
                <input type="text" id="hostName" placeholder="Entrez votre nom" value="Joueur 1">
            </div>

            <button class="btn btn-primary" onclick="createRoom()">üéÆ Cr√©er la partie</button>
            <button class="btn btn-secondary" onclick="showOptions()">‚Üê Retour</button>
        </div>

        <!-- Join Room Form -->
        <div class="form-section" id="joinRoomScreen">
            <h2 style="color: #667eea; margin-bottom: 30px; text-align: center;">Rejoindre une partie</h2>
            
            <div class="input-group">
                <label>Votre nom de joueur</label>
                <input type="text" id="guestName" placeholder="Entrez votre nom" value="Joueur 2">
            </div>

            <div class="input-group">
                <label>Code de la partie</label>
                <input 
                    type="text" 
                    id="roomCodeInput" 
                    placeholder="Entrez le code (8 caract√®res)" 
                    maxlength="8" 
                    style="text-transform: uppercase; text-align: center; font-size: 1.5em; letter-spacing: 0.1em;">
            </div>

            <button class="btn btn-primary" onclick="joinRoom()">üîó Rejoindre la partie</button>
            <button class="btn btn-secondary" onclick="showOptions()">‚Üê Retour</button>
        </div>

        <!-- Waiting Room -->
        <div class="form-section" id="waitingRoomScreen">
            <h2 style="color: #667eea; margin-bottom: 30px; text-align: center;">Salle d'attente</h2>
            
            <div class="room-code-box">
                <div class="room-code-label">üìã Code de la partie</div>
                <div class="room-code" id="displayRoomCode">XXXX</div>
                <button class="copy-button" onclick="copyRoomCode()">üìã Copier le code</button>
            </div>

            <div class="share-section">
                <div class="share-title">üì§ Partagez avec vos amis</div>
                <p style="color: #0c5460; margin-bottom: 15px;">
                    Envoyez ce lien √† vos amis pour qu'ils rejoignent directement :
                </p>
                <div class="share-link-box">
                    <input type="text" id="shareLink" readonly>
                    <button class="copy-button" onclick="copyShareLink()">Copier</button>
                </div>
            </div>

            <div class="player-count" id="playerCount">
                üë• Joueurs : 1 / 6
            </div>

            <div class="waiting-players" id="waitingPlayers"></div>

            <div class="info-box">
                <h3>‚è≥ En attente des joueurs...</h3>
                <ul>
                    <li>Partagez le <strong>code de partie</strong> avec vos amis</li>
                    <li>Attendez que les joueurs rejoignent (minimum 2, maximum 6)</li>
                    <li>Cliquez sur <strong>"Je suis pr√™t!"</strong> quand vous √™tes pr√™t</li>
                    <li>La partie d√©marre automatiquement quand tout le monde est pr√™t!</li>
                </ul>
            </div>

            <button class="btn btn-primary" id="readyButton" onclick="toggleReady()">‚úÖ Je suis pr√™t!</button>
            <button class="btn btn-secondary" onclick="leaveRoom()">üö™ Quitter la partie</button>
        </div>

        <!-- Game Started Screen -->
        <div class="form-section" id="gameStartedScreen">
            <div class="success-message">
                üéâ La partie a commenc√© !
            </div>
            
            <div class="info-box">
                <h3>üéÆ Comment continuer</h3>
                <p style="margin-bottom: 15px;">La partie est maintenant lanc√©e. Pour jouer :</p>
                <ol style="margin-left: 25px; line-height: 1.8;">
                    <li>Ouvrez le fichier <strong>crypto-monopoly-multiplayer.html</strong></li>
                    <li>Tous les joueurs utilisent le m√™me appareil √† tour de r√¥le</li>
                    <li>Ou bien, utilisez un syst√®me de partage d'√©cran pour jouer √† distance</li>
                </ol>
                <p style="margin-top: 20px; color: #0c5460;">
                    <strong>Alternative :</strong> Pour une v√©ritable exp√©rience en ligne avec chacun sur son appareil, 
                    vous auriez besoin d'un serveur backend (WebSocket, Firebase, etc.). Cette version utilise le stockage 
                    cloud pour la synchronisation de salle, mais le jeu lui-m√™me se joue en local.
                </p>
            </div>

            <button class="btn btn-primary" onclick="location.reload()">üîÑ Cr√©er une nouvelle partie</button>
        </div>
    </div>

    <script>
        let gameState = {
            roomCode: null,
            myPlayerId: null,
            players: [],
            isHost: false,
            myReady: false
        };

        const SYNC_INTERVAL = 2000;
        let syncTimer = null;

        function generateRoomCode() {
            const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
            let code = '';
            for (let i = 0; i < 8; i++) {
                code += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return code;
        }

        function generatePlayerId() {
            return 'p_' + Math.random().toString(36).substr(2, 9) + '_' + Date.now();
        }

        function showOptions() {
            document.querySelectorAll('.form-section').forEach(s => s.classList.remove('active'));
            document.getElementById('optionsScreen').classList.add('active');
            stopSync();
        }

        function showCreateRoom() {
            document.querySelectorAll('.form-section').forEach(s => s.classList.remove('active'));
            document.getElementById('createRoomScreen').classList.add('active');
        }

        function showJoinRoom() {
            document.querySelectorAll('.form-section').forEach(s => s.classList.remove('active'));
            document.getElementById('joinRoomScreen').classList.add('active');
        }

        async function createRoom() {
            const name = document.getElementById('hostName').value.trim() || 'H√¥te';
            const roomCode = generateRoomCode();
            const playerId = generatePlayerId();

            gameState.roomCode = roomCode;
            gameState.myPlayerId = playerId;
            gameState.isHost = true;
            gameState.players = [{
                id: playerId,
                name: name,
                ready: false,
                joinedAt: Date.now()
            }];

            try {
                await window.storage.set(`room_${roomCode}`, JSON.stringify(gameState), true);
                showWaitingRoom();
                startSync();
            } catch (error) {
                alert('Erreur lors de la cr√©ation de la partie. V√©rifiez que vous avez activ√© le stockage persistant.');
                console.error(error);
            }
        }

        async function joinRoom() {
            const name = document.getElementById('guestName').value.trim() || 'Invit√©';
            const roomCode = document.getElementById('roomCodeInput').value.trim().toUpperCase();
            
            if (roomCode.length !== 8) {
                alert('Le code doit faire exactement 8 caract√®res!');
                return;
            }

            try {
                const roomData = await window.storage.get(`room_${roomCode}`, true);
                
                if (!roomData) {
                    alert('Cette partie n\'existe pas! V√©rifiez le code.');
                    return;
                }

                const room = JSON.parse(roomData.value);
                
                if (room.players.length >= 6) {
                    alert('Cette partie est compl√®te (6 joueurs maximum).');
                    return;
                }

                const playerId = generatePlayerId();
                const newPlayer = {
                    id: playerId,
                    name: name,
                    ready: false,
                    joinedAt: Date.now()
                };

                room.players.push(newPlayer);
                await window.storage.set(`room_${roomCode}`, JSON.stringify(room), true);

                gameState = room;
                gameState.myPlayerId = playerId;
                gameState.isHost = false;

                showWaitingRoom();
                startSync();
            } catch (error) {
                alert('Erreur lors de la connexion. V√©rifiez le code et r√©essayez.');
                console.error(error);
            }
        }

        function showWaitingRoom() {
            document.querySelectorAll('.form-section').forEach(s => s.classList.remove('active'));
            document.getElementById('waitingRoomScreen').classList.add('active');
            
            document.getElementById('displayRoomCode').textContent = gameState.roomCode;
            
            const shareUrl = window.location.href.split('?')[0] + '?join=' + gameState.roomCode;
            document.getElementById('shareLink').value = shareUrl;
            
            updateWaitingRoom();
        }

        function updateWaitingRoom() {
            const playerList = document.getElementById('waitingPlayers');
            playerList.innerHTML = '';
            
            document.getElementById('playerCount').textContent = 
                `üë• Joueurs : ${gameState.players.length} / 6`;

            gameState.players.forEach((player, index) => {
                const item = document.createElement('div');
                item.className = 'player-item';
                
                const initial = player.name.charAt(0).toUpperCase();
                const isMe = player.id === gameState.myPlayerId;
                
                item.innerHTML = `
                    <div class="player-info">
                        <div class="player-avatar">${initial}</div>
                        <div>
                            <div class="player-name">
                                ${player.name}
                                ${isMe ? '<span style="color: #667eea;">(Vous)</span>' : ''}
                            </div>
                        </div>
                    </div>
                    <span class="status-badge ${player.ready ? 'status-ready' : 'status-waiting'}">
                        ${player.ready ? '‚úÖ Pr√™t' : '‚è≥ En attente'}
                    </span>
                `;
                playerList.appendChild(item);
            });

            // Check if all ready and can start
            const allReady = gameState.players.length >= 2 && 
                           gameState.players.every(p => p.ready);
            
            if (allReady) {
                startGame();
            }
        }

        async function toggleReady() {
            const myPlayer = gameState.players.find(p => p.id === gameState.myPlayerId);
            if (myPlayer) {
                myPlayer.ready = !myPlayer.ready;
                gameState.myReady = myPlayer.ready;
                
                await syncToCloud();
                
                const btn = document.getElementById('readyButton');
                if (myPlayer.ready) {
                    btn.textContent = '‚ùå Annuler';
                    btn.className = 'btn btn-secondary';
                } else {
                    btn.textContent = '‚úÖ Je suis pr√™t!';
                    btn.className = 'btn btn-primary';
                }
                
                updateWaitingRoom();
            }
        }

        function startGame() {
            stopSync();
            document.querySelectorAll('.form-section').forEach(s => s.classList.remove('active'));
            document.getElementById('gameStartedScreen').classList.add('active');
        }

        async function syncToCloud() {
            if (!gameState.roomCode) return;
            
            try {
                await window.storage.set(`room_${gameState.roomCode}`, JSON.stringify(gameState), true);
            } catch (error) {
                console.error('Sync error:', error);
            }
        }

        async function syncFromCloud() {
            if (!gameState.roomCode) return;
            
            try {
                const roomData = await window.storage.get(`room_${gameState.roomCode}`, true);
                
                if (roomData) {
                    const serverState = JSON.parse(roomData.value);
                    const myId = gameState.myPlayerId;
                    
                    gameState = serverState;
                    gameState.myPlayerId = myId;
                    
                    updateWaitingRoom();
                }
            } catch (error) {
                console.error('Sync error:', error);
            }
        }

        function startSync() {
            if (syncTimer) clearInterval(syncTimer);
            syncTimer = setInterval(syncFromCloud, SYNC_INTERVAL);
        }

        function stopSync() {
            if (syncTimer) {
                clearInterval(syncTimer);
                syncTimer = null;
            }
        }

        async function leaveRoom() {
            if (gameState.roomCode && gameState.myPlayerId) {
                gameState.players = gameState.players.filter(p => p.id !== gameState.myPlayerId);
                await syncToCloud();
            }
            
            stopSync();
            location.reload();
        }

        function copyRoomCode() {
            const code = gameState.roomCode;
            navigator.clipboard.writeText(code).then(() => {
                alert('‚úÖ Code copi√©: ' + code + '\n\nPartagez-le avec vos amis!');
            }).catch(() => {
                alert('Code de la partie: ' + code);
            });
        }

        function copyShareLink() {
            const link = document.getElementById('shareLink').value;
            navigator.clipboard.writeText(link).then(() => {
                alert('‚úÖ Lien copi√©!\n\nEnvoyez-le √† vos amis par message ou email.');
            }).catch(() => {
                alert('Lien: ' + link);
            });
        }

        // Auto-join from URL
        window.addEventListener('load', () => {
            const urlParams = new URLSearchParams(window.location.search);
            const joinCode = urlParams.get('join');
            
            if (joinCode) {
                document.getElementById('roomCodeInput').value = joinCode.toUpperCase();
                showJoinRoom();
            }
        });

        // Cleanup
        window.addEventListener('beforeunload', () => {
            stopSync();
        });
    </script>
</body>
</html>
